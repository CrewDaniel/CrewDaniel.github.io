<!DOCTYPE html><html lang="ko" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="[Android] 동영상에 그림 그리기 (3) - OpenGL ES, EGL" /><meta property="og:locale" content="ko" /><meta name="description" content="OpenGL ES 렌더링 과정과 Android에서의 사용법" /><meta property="og:description" content="OpenGL ES 렌더링 과정과 Android에서의 사용법" /><link rel="canonical" href="https://crewdaniel.github.io/posts/video_memo_3/" /><meta property="og:url" content="https://crewdaniel.github.io/posts/video_memo_3/" /><meta property="og:site_name" content="Devroid" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-12-23T00:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[Android] 동영상에 그림 그리기 (3) - OpenGL ES, EGL" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"OpenGL ES 렌더링 과정과 Android에서의 사용법","url":"https://crewdaniel.github.io/posts/video_memo_3/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://crewdaniel.github.io/posts/video_memo_3/"},"headline":"[Android] 동영상에 그림 그리기 (3) - OpenGL ES, EGL","dateModified":"2021-12-24T00:00:00+09:00","datePublished":"2021-12-23T00:00:00+09:00","@context":"https://schema.org"}</script><title>[Android] 동영상에 그림 그리기 (3) - OpenGL ES, EGL | Devroid</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Devroid"><meta name="application-name" content="Devroid"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div class="site-title mt-3"> <a href="/">Devroid</a></div><div class="site-subtitle">안드로이드 개발 일지</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/CrewDaniel" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['alaskay','naver.com'].join('@')" aria-label="email" class="order-4" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-5" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>[Android] 동영상에 그림 그리기 (3) - OpenGL ES, EGL</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>[Android] 동영상에 그림 그리기 (3) - OpenGL ES, EGL</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Taehyun Park </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Dec 23, 2021, 12:00 AM +0900" >Dec 23, 2021<i class="unloaded">2021-12-23T00:00:00+09:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Fri, Dec 24, 2021, 12:00 AM +0000" >Dec 24, 2021<i class="unloaded">2021-12-24T00:00:00+09:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2794 words">15 min read</span></div></div><div class="post-content"><h1 id="opengl-es">OpenGL ES</h1><p>그림을 그리기 위해서는, 어떻게 그림이 그려지는지 알 필요가 있습니다. 저도 이 과정에 대해 감히 모든 것을 알고 정리한다고 말씀드릴 수는 없을 것입니다. 제가 이 앱을 만들기 위해서 공부했던 범위에서 정리하도록 하겠습니다.</p><h2 id="렌더링-파이프라인">렌더링 파이프라인</h2><p>OpenGL ES 3.0의 전체 렌더링 파이프라인은 <a href="https://www.khronos.org/news/permalink/opengl-es-3.0-pipeline-map">크로노스 그룹 웹페이지</a>에서 링크를 통해 찾아볼 수 있습니다. 저는 OpenGL ES를 사용하면서 아래 그림과 같이 최소한으로 간단하게 정리하여 생각하였습니다.</p><p><img data-proofer-ignore data-src="/assets/img/video_memo_3/pipeline.png" alt="pipeline" /></p><p>이 중에서 사각형 상자 내의 <code class="language-plaintext highlighter-rouge">Vertex Processing</code> 과 <code class="language-plaintext highlighter-rouge">Fragment Processing</code> 과정에서 Shading 이라는 부분을 직접 프로그래밍이 가능합니다. Vertex Shader에서는 점의 위치를 결정하고, Fragment Shader에서는 색상을 결정합니다. 다만 Kotlin이 아닌 <code class="language-plaintext highlighter-rouge">GLSL</code> 이라는 별도의 언어를 사용해야 합니다.</p><p>물론 프로그래밍이 가능하지 않다는 것이 어떠한 조작도 불가능하다는 의미는 아닙니다. 제공되는 함수를 통해 기능을 조작 가능하지만, GLSL 등의 별도의 프로그래밍 언어를 사용하지 않는다는 것이고, 조작의 범위또한 제한적입니다.</p><h2 id="버전">버전</h2><p><a href="https://developer.android.com/guide/topics/graphics/opengl?hl=ko">OpenGL ES</a>는 여러 버전이 존재합니다. Android에서 특정 버전을 지원하는지 알기 위해서는 두 가지를 확인해야 합니다.</p><p>첫 번째로 API 레벨입니다. OpenGL ES 2.0은 API 8 이상에서 지원되고, OpenGL ES 3.0은 API 18 이상에서 지원됩니다. 이렇게만 보면 사실상 거의 모든 기기에서 OpenGL ES 3.0을 지원할 것으로 예상되고 실제로도 그렇기는 하지만 한 가지 더 확인해야 할 사항이 있습니다.</p><p>바로 GPU의 지원 여부입니다. GPU마다 지원하는 OpenGL ES의 버전이 다르기 때문에 기기에 따라 지원 여부가 달라질 수 있습니다. 물론 OpenGL ES 3.0이 <a href="https://www.khronos.org/news/press/khronos-releases-opengl-es-3.0-specification">2012년 8월</a>에 공개된 것을 감안하면 거의 모든 기기가 지원하기는 하지만 <a href="https://developer.android.com/about/dashboards#OpenGL">Android 개발자 문서의 통계</a>에 따르면 2020년 8월에도 OpenGL ES 2.0은 12%의 점유율을 가지고 있습니다.</p><p>다행히 하위호환이 되어 OpenGL ES 3.X를 지원하는 기기에서 OpenGL ES 2.0을 사용할 수 있습니다(OpenGL ES 1.X까지 지원하지는 않습니다. OpenGL 1.X와 2.0은 렌더링 파이프라인에 큰 차이가 있습니다. 1.X까지는 고정 파이프라인을 사용하다가 2.0부터 이를 제거하고 Shader 파이프라인, 즉 프래그래밍이 가능한 파이프라인으로 변경되었습니다).</p><p>그렇다면 OpenGL ES 2.0을 지원하는 기기에서 실행이 가능하도록 하고, OpenGL ES 3.X를 지원한다면 추가적인 기능을 사용하도록 구현하면 될 것입니다. 우선 OpenGL ES 2.0을 지원하는 기기에서만 설치될 수 있도록 해야합니다.</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span text-data=" XML "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nt">&lt;uses-feature</span> <span class="na">android:glEsVersion=</span><span class="s">"0x00020000"</span> <span class="na">android:required=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">AndroidManifest.xml</code>에 위 코드를 포함하면 됩니다. 그렇다면 OpenGL ES 3.X의 지원여부는 어떻게 알 수 있을까요? 이 부분은 아래 EGL 초기화 과정에 포함이 되어있습니다.</p><h1 id="egl">EGL</h1><p>SurfaceTexture는 이미지 스트림 생성자에서 받은 이미지를 Texture로 사용하여 새로운 이미지를 그려내야 합니다. 그렇다면 어디에 그려야 할까요? <a href="https://crewdaniel.github.io/posts/video_memo_1/#%EC%A0%95%EB%A6%AC">이 앱</a>에서는 화면을 보여주기 위한 SurfaceView와, 동영상을 저장하기 위한 MediaCodec 두 가지가 필요합니다. OpenGL ES로 렌더링한 결과물은 어디에 그려지는지와, OpenGL ES로 렌더링을 하기 전 초기화 과정에 대해 알기 위해서는 EGL에 대한 이해가 필요합니다.</p><p>EGL은 크로노스 그룹의 API들과 여러 플랫폼의 호환을 위해 만들어졌습니다. OpenGL ES 뿐만이 아니라 OpenGL, OpenVG를 사용할 때도 쓰이며, 이러한 라이브러리들이 Android 외에도 다양한 OS와 프로그램에 쓰이기 때문에 이 둘을 이어주는 인터페이스가 필요했기 때문입니다.</p><p>EGL의 초기화 단계를 차례대로 살펴보겠습니다. 첫 번째 단계는 EGLDisplay 설정입니다.</p><h2 id="egldisplay">EGLDisplay</h2><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">private</span> <span class="k">fun</span> <span class="nf">getEglDisplay</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">eglDisplay</span> <span class="p">=</span> <span class="nc">EGL14</span><span class="p">.</span><span class="nf">eglGetDisplay</span><span class="p">(</span><span class="nc">EGL14</span><span class="p">.</span><span class="nc">EGL_DEFAULT_DISPLAY</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">eglDisplay</span> <span class="p">===</span> <span class="nc">EGL14</span><span class="p">.</span><span class="nc">EGL_NO_DISPLAY</span><span class="p">)</span> <span class="k">throw</span> <span class="nc">Exception</span><span class="p">(</span><span class="s">"EGLDisplay 가져오기 실패"</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p><a href="https://developer.android.com/reference/android/opengl/EGL14">EGL14</a>는 EGL 1.4를 의미합니다. EGL 1.5가 Android 10(API 29)부터 지원되지만 미만의 버전에서 호환성이 우려되어 API 17에 추가된 EGL 1.4를 사용하였습니다.</p><p><code class="language-plaintext highlighter-rouge">eglGetDisplay(displayId: Int)</code> 함수를 통해 연결할 디스플레이를 지정하고, 하드웨어 사양을 가져옵니다. <code class="language-plaintext highlighter-rouge">EGL14.EGL_DEFAULT_DISPLAY</code>로 지정하면 OS에서 지정한 기본값을 넣어주게 됩니다.</p><h2 id="eglinitialize">eglInitialize</h2><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">private</span> <span class="k">fun</span> <span class="nf">eglInit</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">version</span> <span class="p">=</span> <span class="nc">IntArray</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(!</span><span class="nc">EGL14</span><span class="p">.</span><span class="nf">eglInitialize</span><span class="p">(</span><span class="n">eglDisplay</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">throw</span> <span class="nc">Exception</span><span class="p">(</span><span class="s">"EGL 초기화 실패"</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p>다음으로는 <code class="language-plaintext highlighter-rouge">eglInitialize(dpy: EGLDisplay, major: IntArray, majorOffset: Int, minor: IntArray, minorOffset: Int)</code> 함수를 사용하여 EGLDisplay 연결을 초기화합니다. 파라미터가 많아서 어렵게 느껴질 수도 있지만 여기서 중요한 것은 <code class="language-plaintext highlighter-rouge">eglDisplay</code> 하나입니다. 위에서 선언한 eglDisplay 값을 그대로 넣어주면 됩니다.</p><p><code class="language-plaintext highlighter-rouge">version</code>은 함수 실행 결과 후 version에 EGL 버전 값이 들어가게 됩니다. 하지만 이후에도 EGL 1.4를 사용할 것이기 때문에 이후에 version을 사용하지는 않을 것입니다. 실행 결과는 Boolean 값으로 반환되며 false 반환시 초기화 실패입니다.</p><h2 id="eglbind">eglBind</h2><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">private</span> <span class="k">fun</span> <span class="nf">eglBind</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(!</span><span class="nc">EGL14</span><span class="p">.</span><span class="nf">eglBindAPI</span><span class="p">(</span><span class="nc">EGL14</span><span class="p">.</span><span class="nc">EGL_OPENGL_ES_API</span><span class="p">))</span> <span class="k">throw</span> <span class="nc">Exception</span><span class="p">(</span><span class="s">"EGL 렌더링 API 설정 실패"</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p>이후 <code class="language-plaintext highlighter-rouge">eglBindAPI(api: Int)</code> 함수에서 OpenGL ES를 사용할 것을 선언합니다.</p><h2 id="eglconfig">EGLConfig</h2><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="k">private</span> <span class="k">fun</span> <span class="nf">getEglConfig</span><span class="p">(</span><span class="n">version</span><span class="p">:</span> <span class="nc">Int</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="py">renderableType</span> <span class="p">=</span> <span class="nc">EGL14</span><span class="p">.</span><span class="nc">EGL_OPENGL_ES2_BIT</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="p">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">renderableType</span> <span class="p">=</span> <span class="n">renderableType</span> <span class="n">or</span> <span class="nc">EGLExt</span><span class="p">.</span><span class="nc">EGL_OPENGL_ES3_BIT_KHR</span>
    <span class="p">}</span>

    <span class="kd">val</span> <span class="py">attribList</span> <span class="p">=</span> <span class="nf">intArrayOf</span><span class="p">(</span>
        <span class="nc">EGL14</span><span class="p">.</span><span class="nc">EGL_RED_SIZE</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
        <span class="nc">EGL14</span><span class="p">.</span><span class="nc">EGL_GREEN_SIZE</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
        <span class="nc">EGL14</span><span class="p">.</span><span class="nc">EGL_BLUE_SIZE</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
        <span class="nc">EGL14</span><span class="p">.</span><span class="nc">EGL_ALPHA_SIZE</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
        <span class="nc">EGL14</span><span class="p">.</span><span class="nc">EGL_RENDERABLE_TYPE</span><span class="p">,</span> <span class="n">renderableType</span><span class="p">,</span>
        <span class="nc">EGL_RECORDABLE_ANDROID</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nc">EGL14</span><span class="p">.</span><span class="nc">EGL_NONE</span>
    <span class="p">)</span>

    <span class="kd">val</span> <span class="py">configs</span> <span class="p">=</span> <span class="n">arrayOfNulls</span><span class="p">&lt;</span><span class="nc">EGLConfig</span><span class="p">&gt;(</span><span class="mi">1</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">numConfigs</span> <span class="p">=</span> <span class="nc">IntArray</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(!</span><span class="nc">EGL14</span><span class="p">.</span><span class="nf">eglChooseConfig</span><span class="p">(</span><span class="n">eglDisplay</span><span class="p">,</span> <span class="n">attribList</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">configs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numConfigs</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="nc">Log</span><span class="p">.</span><span class="nf">d</span><span class="p">(</span><span class="nc">TAG</span><span class="p">,</span> <span class="s">"$version EGLConfig 실패"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">eglConfig</span> <span class="p">=</span> <span class="n">configs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">}</span>
</pre></table></code></div></div><p>이제 EGLConfig를 가져와야 합니다. 다른 함수들과는 다른 특이한 작동방식을 쓰는데, 위의 코드에서 <code class="language-plaintext highlighter-rouge">attribList</code>에 사용하기 원하는 속성과 값을 Array에 순서대로 넣어줍니다. 렌더링 방식은 일반적인 RGBA_8888을 사용할 것입니다.</p><p><code class="language-plaintext highlighter-rouge">EGL14.EGL_RENDERABLE_TYPE</code>은 비스마스킹 방식으로 값을 지정해주어야 합니다. 각 값들이 1, 2, 4, 8 등으로 다른 비트 값을 가지고 있기 때문에 or 연산을 하면 됩니다. 위의 코드에서 <code class="language-plaintext highlighter-rouge">EGL14.EGL_OPENGL_ES2_BIT</code>은 4이고, <code class="language-plaintext highlighter-rouge">EGLExt.EGL_OPENGL_ES3_BIT_KHR</code>은 64입니다. OpenGL ES는 하위호환이 되기 때문에 OpenGL ES 2.0까지만 지원하는 기기에서는 or 연산으로 더하는 과정을 빼고, OpenGL ES 3.0을 지원한다면 두 값을 or 연산으로 더한 값을 사용하면 됩니다.</p><p>위의 <code class="language-plaintext highlighter-rouge">getEglConfig(version: Int)</code> 함수에서 <code class="language-plaintext highlighter-rouge">getEglConfig(3)</code>을 먼저 시도하여 성공하면 두 버전 모두를 사용하는 EGLConfig를 반환받고, 실패하면 <code class="language-plaintext highlighter-rouge">getEglConfig(2)</code>로 OpenGL ES 2.0만을 사용하는 EGLConfig를 반환받도록 코드를 작성하였습니다.</p><p><code class="language-plaintext highlighter-rouge">EGL_RECORDABLE_ANDROID</code>는 별도의 상수를 지정하였습니다. 12610(0x3142) 값을 가지고 있습니다. 이 상수는 <a href="https://developer.android.com/reference/android/opengl/EGLExt#EGL_RECORDABLE_ANDROID">EGLExt.EGL_RECORDABLE_ANDROID</a>로 이미 지정이 되어있긴 하지만, API 26에 추가되었기 때문에 Min API 21이었던 제 앱에서는 별도로 값을 입력하였습니다.</p><p><code class="language-plaintext highlighter-rouge">attribList</code> 배열의 마지막 <code class="language-plaintext highlighter-rouge">EGL14.EGL_NONE</code> 값은 배열의 종료를 나타내는 값입니다.</p><p>함수 실행 성공시에 <code class="language-plaintext highlighter-rouge">configs</code>에 속성에 맞는 EGLConfig가 반환됩니다.</p><p>이외에도 속성이 많기 때문에 크로노스 그룹의 <a href="https://www.khronos.org/registry/EGL/sdk/docs/man/html/eglChooseConfig.xhtml">eglChooseConfig</a> 문서와 함께 사용할 수 있는 값들에 대해 Android의 <a href="https://developer.android.com/reference/android/opengl/EGL14">EGL14</a> 페이지를 함께 참고해 사용 가능한 속성들을 찾으시는 것을 추천드립니다. 만약 속성들 중 입력하지 않은 값이 있다면 eglChooseConfig 링크에 적혀있는 기본값이 적용됩니다.</p><h2 id="eglcontext">EGLContext</h2><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="k">private</span> <span class="k">fun</span> <span class="nf">getEglContext</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">getEglConfig</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">eglConfig</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">gl3Setup</span> <span class="p">=</span> <span class="nf">intArrayOf</span><span class="p">(</span><span class="nc">EGL14</span><span class="p">.</span><span class="nc">EGL_CONTEXT_CLIENT_VERSION</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nc">EGL14</span><span class="p">.</span><span class="nc">EGL_NONE</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">context</span> <span class="p">=</span> <span class="nc">EGL14</span><span class="p">.</span><span class="nf">eglCreateContext</span><span class="p">(</span>
            <span class="n">eglDisplay</span><span class="p">,</span> <span class="n">eglConfig</span><span class="p">,</span> <span class="nc">EGL14</span><span class="p">.</span><span class="nc">EGL_NO_CONTEXT</span><span class="p">,</span>
            <span class="n">gl3Setup</span><span class="p">,</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nc">EGL14</span><span class="p">.</span><span class="nf">eglGetError</span><span class="p">()</span> <span class="p">==</span> <span class="nc">EGL14</span><span class="p">.</span><span class="nc">EGL_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
            <span class="nc">Log</span><span class="p">.</span><span class="nf">d</span><span class="p">(</span><span class="nc">TAG</span><span class="p">,</span> <span class="s">"GLES3 Config"</span><span class="p">)</span>
            <span class="n">eglContext</span> <span class="p">=</span> <span class="n">context</span>
            <span class="n">glVersion</span> <span class="p">=</span> <span class="mi">3</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nf">getEglConfig</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">gl2Setup</span> <span class="p">=</span> <span class="nf">intArrayOf</span><span class="p">(</span><span class="nc">EGL14</span><span class="p">.</span><span class="nc">EGL_CONTEXT_CLIENT_VERSION</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nc">EGL14</span><span class="p">.</span><span class="nc">EGL_NONE</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">context</span> <span class="p">=</span> <span class="nc">EGL14</span><span class="p">.</span><span class="nf">eglCreateContext</span><span class="p">(</span>
            <span class="n">eglDisplay</span><span class="p">,</span> <span class="n">eglConfig</span><span class="p">,</span> <span class="nc">EGL14</span><span class="p">.</span><span class="nc">EGL_NO_CONTEXT</span><span class="p">,</span>
            <span class="n">gl2Setup</span><span class="p">,</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="nc">Log</span><span class="p">.</span><span class="nf">d</span><span class="p">(</span><span class="nc">TAG</span><span class="p">,</span> <span class="s">"GLES2 Config"</span><span class="p">)</span>
        <span class="n">eglContext</span> <span class="p">=</span> <span class="n">context</span>
        <span class="n">glVersion</span> <span class="p">=</span> <span class="mi">2</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>마지막으로 EGLContext를 생성하여야 합니다. <code class="language-plaintext highlighter-rouge">EGL14.eglCreateContext(dpy: EGLDisplay, config: EGLConfig, shareContext: EGLContext, attribList: IntArray, offset: Int)</code> 함수로 생성하면 되는데, 앞에서 생성한 EGLDisplay와 EGLConfig가 들어가고, <code class="language-plaintext highlighter-rouge">shareContext</code>는 데이터를 공유할 또다른 EGLContext를 적는 파라미터입니다. 이 코드에서는 해당하지 않았기 때문에 <code class="language-plaintext highlighter-rouge">EGL14.EGL_NO_CONTEXT</code> 값을 지정하였습니다.</p><p>그 다음으로 들어가는 gl3Setup, gl2Setup은 <code class="language-plaintext highlighter-rouge">eglBindAPI(api: Int)</code>로 앞에서 선언했던 OpenGL ES의 버전을 선언하는 배열입니다. EGLConfig에서 attribList를 선언한 방법과 같이 속성과 값을 순서대로 넣고, <code class="language-plaintext highlighter-rouge">EGL14.EGL_NONE</code> 으로 배열의 끝을 알리는 방식입니다. <code class="language-plaintext highlighter-rouge">EGL14.EGL_CONTEXT_CLIENT_VERSION</code> 속성의 값을 <code class="language-plaintext highlighter-rouge">3</code>으로 설정하여 OpenGL ES 3.0이 가능한지 확인하고, 성공시 그대로 EGLContext를 가져와 사용합니다. 실패시 OpenGL ES 2.0을 같은 방식으로 시도합니다.</p><p>실제로 사용시에는 OpenGL ES 2.0의 코드 위주로 사용하고, OpenGL ES 3.0을 사용하였을 때 성능 향상이 있을 경우에만 버전 확인 후 사용하고, 그 경우에도 OpenGL ES 2.0의 코드만으로도 작성할 수 있는 방법을 함께 구현하여 버전에 따라 사용하도록 하였습니다.</p><p>이렇게 해서 EGL 초기화 과정을 마쳤고, OpenGL ES의 사용 가능한 버전을 런타임으로 확인하여 설정할 수 있었습니다. 다음 포스팅에서는 OpenGL ES를 사용하여 렌더링 과정에서 어떻게 동영상의 각 프레임 이미지를 표시하기 위해 텍스처를 초기화하고 이미지를 텍스처로 사용하는 법에 대해 작성하도록 하겠습니다.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/android/'>Android</a>, <a href='/categories/boomerang/'>boomerang</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/android/" class="post-tag no-text-decoration" >Android</a> <a href="/tags/opengl-es/" class="post-tag no-text-decoration" >OpenGL ES</a> <a href="/tags/egl/" class="post-tag no-text-decoration" >EGL</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=[Android] 동영상에 그림 그리기 (3) - OpenGL ES, EGL - Devroid&url=https://crewdaniel.github.io/posts/video_memo_3/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=[Android] 동영상에 그림 그리기 (3) - OpenGL ES, EGL - Devroid&u=https://crewdaniel.github.io/posts/video_memo_3/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=[Android] 동영상에 그림 그리기 (3) - OpenGL ES, EGL - Devroid&url=https://crewdaniel.github.io/posts/video_memo_3/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/cs_3/">[CS] 비동기 프로그래밍 (3) - 동시성 프로그래밍</a><li><a href="/posts/cs_2/">[CS] 비동기 프로그래밍 (2) - 리눅스의 프로세스, 스레드, 태스크</a><li><a href="/posts/cs_1/">[CS] 비동기 프로그래밍 (1) - 캐시 메모리</a><li><a href="/posts/video_memo_10/">[Android] 동영상에 그림 그리기 (10) - 개선 리스트</a><li><a href="/posts/video_memo_8/">[Android] 동영상에 그림 그리기 (8) - BufferQueue, WindowManager, SurfaceFlinger</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/opengl-es/">OpenGL ES</a> <a class="post-tag" href="/tags/cs/">CS</a> <a class="post-tag" href="/tags/surface/">Surface</a> <a class="post-tag" href="/tags/egl/">EGL</a> <a class="post-tag" href="/tags/shader/">Shader</a> <a class="post-tag" href="/tags/surfacetexture/">SurfaceTexture</a> <a class="post-tag" href="/tags/async/">Async</a> <a class="post-tag" href="/tags/asynchronous/">Asynchronous</a> <a class="post-tag" href="/tags/boostcamp/">boostcamp</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/video_memo_6/"><div class="card-body"> <span class="timeago small" >Jan 2<i class="unloaded">2022-01-02T00:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[Android] 동영상에 그림 그리기 (6) - Framebuffer 전달 및 복사</h3><div class="text-muted small"><p> OpenGL ES의 렌더링 과정을 모두 마치면, EGLSurface에 Framebuffer가 들어가게 됩니다. 그런데 이 앱에서 Framebuffer가 필요한 Surface는 두 곳이 있습니다. 하나는 화면에 표시하기 위한 SurfaceView이고, 다른 하나는 동영상 저장을 위한 MediaCodec 입니다. 이 과정에서 제가 구현한 방법과 각 방법에...</p></div></div></a></div><div class="card"> <a href="/posts/video_memo_4/"><div class="card-body"> <span class="timeago small" >Dec 31, 2021<i class="unloaded">2021-12-31T00:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[Android] 동영상에 그림 그리기 (4) - OpenGL ES의 Texture</h3><div class="text-muted small"><p> 이제 그림을 그릴 시간입니다. Android에서 OpenGL ES 렌더링 과정, 특히 SurfaceTexture를 사용하여 이미지를 텍스처로 사용하는 과정에 대해 정리하겠습니다. SurfaceTexture Texture 초기화 지난 글에서 onFrameAvailableListener를 통해 새로운 이미지 프레임을 받은 것을 알 수 있다고 하였습니...</p></div></div></a></div><div class="card"> <a href="/posts/video_memo_5/"><div class="card-body"> <span class="timeago small" >Jan 1<i class="unloaded">2022-01-01T00:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[Android] 동영상에 그림 그리기 (5) - OpenGL ES의 Shader, 그림 그리기</h3><div class="text-muted small"><p> 렌더링을 위해서는 Shader가 필요합니다. 이번 포스트에서는 Shader에 대해 작성하도록 하겠습니다. Shader 렌더링 파이프라인에서 Vertex Shader와 Fragment Shader는 필수적으로 사용자가 직접 구현해야 하는 부분입니다. GLSL이라는 언어를 사용하여 구현하여야 합니다. Vertex Shader 입력되는 점마다 하나씩...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/video_memo_2/" class="btn btn-outline-primary" prompt="Older"><p>[Android] 동영상에 그림 그리기 (2) - Surface</p></a> <a href="/posts/video_memo_4/" class="btn btn-outline-primary" prompt="Newer"><p>[Android] 동영상에 그림 그리기 (4) - OpenGL ES의 Texture</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/CrewDaniel">Taehyun Park</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/opengl-es/">OpenGL ES</a> <a class="post-tag" href="/tags/cs/">CS</a> <a class="post-tag" href="/tags/surface/">Surface</a> <a class="post-tag" href="/tags/egl/">EGL</a> <a class="post-tag" href="/tags/shader/">Shader</a> <a class="post-tag" href="/tags/surfacetexture/">SurfaceTexture</a> <a class="post-tag" href="/tags/async/">Async</a> <a class="post-tag" href="/tags/asynchronous/">Asynchronous</a> <a class="post-tag" href="/tags/boostcamp/">boostcamp</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
